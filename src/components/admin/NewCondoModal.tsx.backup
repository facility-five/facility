"use client";

import { zodResolver } from "@hookform/resolvers/zod";
import { useForm } from "react-hook-form";
import { z } from "zod";
import { useEffect, useState } from "react";
import { supabase } from "@/integrations/supabase/client";
import { showRadixError, showRadixSuccess } from "@/utils/toast";
import { condominiumSchema, emailSchema, phoneSchema } from "@/utils/validationSchemas";

import { Button } from "@/components/ui/button";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
  DialogDescription,
} from "@/components/ui/dialog";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";

// Schema melhorado para condomínio com validações robustas
const formSchema = z.object({
  name: z
    .string()
    .min(1, "O nome do condomínio é obrigatório.")
    .max(200, "O nome não pode ter mais de 200 caracteres.")
    .regex(/^[a-zA-ZÀ-ÿ\s\d\-_.,()'\"]+$/, {
      message: "O nome deve conter apenas letras, números e espaços."
    }),
  nif: z
    .string()
    .optional()
    .refine((val) => !val || /^\d+$/.test(val), {
      message: "O NIF deve conter apenas números."
    })
    .refine((val) => !val || val.length >= 8, {
      message: "O NIF deve ter pelo menos 8 dígitos."
    }),
  website: z
    .string()
    .optional()
    .refine((val) => !val || /^https?:\/\/.+/.test(val), {
      message: "O website deve começar com http:// ou https://."
    }),
  area: z
    .string()
    .optional()
    .refine((val) => !val || /^\d+(\.\d+)?$/.test(val), {
      message: "A área deve ser um número válido."
    }),
  type: z.enum(['residencial', 'comercial', 'misto']).default('residencial'),
  total_blocks: z.coerce
    .number()
    .int("O número de blocos deve ser um número inteiro.")
    .min(0, "O número de blocos não pode ser negativo.")
    .max(999, "O número de blocos não pode ser maior que 999.")
    .optional(),
  total_units: z.coerce
    .number()
    .int("O número de unidades deve ser um número inteiro.")
    .min(0, "O número de unidades não pode ser negativo.")
    .max(9999, "O número de unidades não pode ser maior que 9999.")
    .optional(),
  email: emailSchema.optional().or(z.literal('')),
  phone: phoneSchema.optional().or(z.literal('')),
  observations: z
    .string()
    .optional()
    .max(1000, "As observações não podem ter mais de 1000 caracteres."),
  responsible_name: z
    .string()
    .optional()
    .max(100, "O nome do responsável não pode ter mais de 100 caracteres.")
    .regex(/^[a-zA-ZÀ-ÿ\s]+$/, {
      message: "O nome do responsável deve conter apenas letras e espaços."
    }),
});



});

interface NewCondoModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSuccess: () => void;
  initialAdministratorId?: string; // ID da administradora selecionada
}

export const NewCondoModal = ({
  isOpen,
  onClose,
  onSuccess,
  initialAdministratorId,
}: NewCondoModalProps) => {

  const form = useForm<z.infer<typeof formSchema>>({
    resolver: zodResolver(formSchema),
    defaultValues: {
      name: "",
      nif: "",
      website: "",
      area: "",
      type: "residencial",
      total_blocks: 0,
      total_units: 0,
      email: "",
      phone: "",
      observations: "",
      responsible_name: "",
    },
  });

  useEffect(() => {
    if (isOpen) {
      form.reset({
        name: "",
        nif: "",
        website: "",
        area: "",
        type: "residencial",
        total_blocks: 0,
        total_units: 0,
        email: "",
        phone: "",
        observations: "",
        responsible_name: "",
      });
    }
  }, [isOpen, initialAdministratorId, form]);

  const generateCode = () => `CO-${Math.random().toString(36).substr(2, 6).toUpperCase()}`;

  async function onSubmit(values: z.infer<typeof formSchema>) {
    if (!initialAdministratorId) {
      showRadixError("Nenhuma administradora selecionada");
      return;
    }

    // Build a defensive payload. Some DBs have `type`, others `condo_type`.
    const raw: any = { ...values };
    const typeValue = raw.type ?? raw.condo_type;

    // Clean up incoming values: remove empty strings
    Object.keys(raw).forEach((k) => {
      if (typeof raw[k] === "string" && raw[k].trim() === "") delete raw[k];
    });

    // Base row to insert
    const baseRow: any = {
      ...raw,
      administrator_id: initialAdministratorId,
      code: generateCode(),
    };

    // Try 1: send `type` if we have a value
    const tryRow = { ...baseRow };
    if (typeValue !== undefined && typeValue !== "") tryRow.type = typeValue;

    // Use safeInsert helper which retries by removing missing columns reported by the server
    const { safeInsert } = await import("@/lib/supabaseHelpers");
    const insertRes = await safeInsert("condominiums", tryRow as Record<string, any>);

    if (insertRes.error) {
      showRadixError(insertRes.error.message || "Erro ao criar condomínio");
      return;
    }

    showRadixSuccess("Condomínio registrado com sucesso!");
    onSuccess();
    onClose();
    form.reset();
  }

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="sm:max-w-2xl bg-admin-card border-admin-border text-admin-foreground">
        <DialogHeader>
          <DialogTitle>Registrar Nuevo Condominio</DialogTitle>
          <DialogDescription className="text-admin-foreground-muted">
            Complete los datos del nuevo condominio.
          </DialogDescription>
        </DialogHeader>
        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4 max-h-[70vh] overflow-y-auto pr-4" autoComplete="off">
            {/* Hidden fields to prevent browser autofill from populating visible inputs (email/password capture) */}
            <input aria-hidden="true" style={{position: 'absolute', opacity: 0, height: 0, width: 0, overflow: 'hidden', pointerEvents: 'none'}} type="text" name="__email_autofill" autoComplete="email" />
            <input aria-hidden="true" style={{position: 'absolute', opacity: 0, height: 0, width: 0, overflow: 'hidden', pointerEvents: 'none'}} type="password" name="__password_autofill" autoComplete="new-password" />
            <FormField
              control={form.control}
              name="name"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Nombre</FormLabel>
                    <FormControl>
                    <Input placeholder="Escriba el nombre del condominio" {...field} className="bg-admin-background border-admin-border" autoComplete="name" />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <FormField
                control={form.control}
                name="nif"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>NIF</FormLabel>
                      <FormControl>
                      <Input placeholder="NIF" {...field} className="bg-admin-background border-admin-border" autoComplete="off" />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
              <FormField
                control={form.control}
                name="website"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Sitio web</FormLabel>
                      <FormControl>
                      <Input placeholder="Ingrese el sitio web" {...field} className="bg-admin-background border-admin-border" autoComplete="off" />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <FormField
                control={form.control}
                name="area"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Área</FormLabel>
                      <FormControl>
                      <Input placeholder="Ingrese el área" {...field} className="bg-admin-background border-admin-border" autoComplete="off" />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
              <FormField
                control={form.control}
                name="type"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Tipo</FormLabel>
                    <FormControl>
                      <Select onValueChange={field.onChange} value={field.value || "residencial"}>
                        <SelectTrigger className="bg-admin-background border-admin-border">
                          <SelectValue placeholder="Seleccione el tipo" />
                        </SelectTrigger>
                        <SelectContent className="bg-admin-card border-admin-border text-admin-foreground">
                          <SelectItem value="residencial">Residencial</SelectItem>
                          <SelectItem value="comercial">Comercial</SelectItem>
                          <SelectItem value="mixto">Mixto</SelectItem>
                        </SelectContent>
                      </Select>
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <FormField
                control={form.control}
                name="total_blocks"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Total de Bloques</FormLabel>
                      <FormControl>
                      <Input type="number" placeholder="Ingrese el número total de bloques" {...field} className="bg-admin-background border-admin-border" autoComplete="off" />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
              <FormField
                control={form.control}
                name="total_units"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Total de Unidades</FormLabel>
                      <FormControl>
                      <Input type="number" placeholder="Ingrese el número total de unidades" {...field} className="bg-admin-background border-admin-border" autoComplete="off" />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <FormField
                control={form.control}
                name="email"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Correo electrónico</FormLabel>
                      <FormControl>
                      <Input placeholder="Ingrese el correo electrónico" {...field} className="bg-admin-background border-admin-border" autoComplete="email" />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
              <FormField
                control={form.control}
                name="phone"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Teléfono</FormLabel>
                      <FormControl>
                      <Input placeholder="Ingrese el teléfono" {...field} className="bg-admin-background border-admin-border" autoComplete="tel" />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>
             <FormField
                control={form.control}
                name="responsible_name"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Responsável</FormLabel>
                      <FormControl>
                      <Input placeholder="Nome do responsável" {...field} className="bg-admin-background border-admin-border" autoComplete="off" />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            <FormField
              control={form.control}
              name="observations"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Observaciones</FormLabel>
                  <FormControl>
                    <Textarea placeholder="Ingrese las observaciones" {...field} className="bg-admin-background border-admin-border" />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />
            <DialogFooter>
              <Button type="button" variant="ghost" onClick={onClose}>
                Cancelar
              </Button>
              <Button type="submit" className="bg-purple-600 hover:bg-purple-700">
                Registrar
              </Button>
            </DialogFooter>
          </form>
        </Form>
      </DialogContent>
    </Dialog>
  );
};
